api_version: 1.0


id: boostsecurityio/trivy-sbom-image
name: Boostsecurity Trivy SBOM Image Scanner
namespace: boostsecurityio/trivy-sbom-image


config:
  support_diff_scan: false


setup:
  - name: download trivy
    environment:
      VERSION: 0.33.0
    run: |
      BINARY_URL="https://github.com/aquasecurity/trivy/releases/download/v${VERSION}"
      ARCH=$(uname -m)

      case "$(uname -sm)" in
        "Linux x86_64")
          BINARY_URL="${BINARY_URL}/trivy_${VERSION}_Linux-64bit.tar.gz"
          SHA="01de599ddceef2296a3f3ef3c0aba4599bcac6114958f2b1922addc1a1b22f25 trivy.tgz"
          ;;
        "Linux aarch64")
          BINARY_URL="${BINARY_URL}/trivy_${VERSION}_Linux-ARM64.tar.gz"
          SHA="1fe527dc58e39445cbafec026cde96b40602ad876d77a1b00882e3bf9aca1c05 trivy.tgz"
          ;;
        "Darwin arm64")
          BINARY_URL="${BINARY_URL}/trivy_${VERSION}_macOS-ARM64.tar.gz"
          SHA="2485f2278a7823c3fc6332e30d29c1c79da8d7243b76276778cc98f2c3f7d2bf trivy.tgz"
          ;;
        *)
          echo "Unsupported machine: ${OPTARG}"
          exit 1
          ;;
      esac

      curl -o trivy.tgz -fsSL "${BINARY_URL}"
      echo "${SHA}" | sha256sum --check

      tar --no-same-owner -zxf trivy.tgz trivy
      rm trivy.tgz
      chmod +x trivy

steps:
  - scan:
      command:
        environment:
          IMAGE_NAME: ${BOOST_IMAGE_NAME}
        run: |
            $SETUP_PATH/trivy image ${TRIVY_ADDITIONAL_ARGS} --format cyclonedx ${BOOST_IMAGE_NAME}
      format: cyclonedx
